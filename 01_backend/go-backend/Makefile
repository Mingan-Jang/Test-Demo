# Makefile for Holiday System

.PHONY: help build run test clean docker-build docker-run docker-compose-up docker-compose-down gcp-deploy migrate lint

help:
	@echo "ç¯€å‡æ—¥ç³»çµ± - å¯ç”¨å‘½ä»¤"
	@echo ""
	@echo "æœ¬åœ°é–‹ç™¼:"
	@echo "  make build          - æ§‹å»ºæ‡‰ç”¨"
	@echo "  make run            - é‹è¡Œæ‡‰ç”¨"
	@echo "  make test           - é‹è¡Œæ¸¬è©¦"
	@echo "  make clean          - æ¸…ç†æ§‹å»ºæ–‡ä»¶"
	@echo "  make migrate        - åŸ·è¡Œæ•¸æ“šåº«é·ç§»"
	@echo ""
	@echo "Docker:"
	@echo "  make docker-build   - æ§‹å»º Docker é¡åƒ"
	@echo "  make docker-run     - é‹è¡Œ Docker å®¹å™¨"
	@echo "  make docker-compose-up   - ä½¿ç”¨ docker-compose å•Ÿå‹•"
	@echo "  make docker-compose-down - åœæ­¢ docker-compose"
	@echo ""
	@echo "GCP éƒ¨ç½²:"
	@echo "  make gcp-deploy     - éƒ¨ç½²åˆ° GCP"
	@echo ""
	@echo "ä»£ç¢¼è³ªé‡:"
	@echo "  make lint           - é‹è¡Œ linter"
	@echo "  make fmt            - æ ¼å¼åŒ–ä»£ç¢¼"

build:
	@echo "ğŸ”¨ æ§‹å»ºæ‡‰ç”¨..."
	go build -o holiday-api ./cmd/api/main.go
	@echo "âœ… æ§‹å»ºå®Œæˆ: ./holiday-api"

run: build
	@echo "ğŸš€ é‹è¡Œæ‡‰ç”¨..."
	./holiday-api

test:
	@echo "ğŸ§ª é‹è¡Œæ¸¬è©¦..."
	go test -v ./...
	@echo "âœ… æ¸¬è©¦å®Œæˆ"

clean:
	@echo "ğŸ§¹ æ¸…ç†æ–‡ä»¶..."
	rm -f holiday-api
	go clean
	@echo "âœ… æ¸…ç†å®Œæˆ"

migrate:
	@echo "ğŸ“Š åŸ·è¡Œæ•¸æ“šåº«é·ç§»..."
	go run ./cmd/migrate/main.go
	@echo "âœ… é·ç§»å®Œæˆ"

docker-build:
	@echo "ğŸ³ æ§‹å»º Docker é¡åƒ..."
	docker build -t holiday-system:latest .
	@echo "âœ… Docker é¡åƒæ§‹å»ºå®Œæˆ"

docker-run: docker-build
	@echo "ğŸš€ é‹è¡Œ Docker å®¹å™¨..."
	docker run -p 8080:8080 \
		-e HOLIDAY_DATABASE_HOST=localhost \
		-e HOLIDAY_DATABASE_PORT=5432 \
		-e HOLIDAY_DATABASE_USERNAME=postgres \
		-e HOLIDAY_DATABASE_PASSWORD=postgres \
		-e HOLIDAY_DATABASE_DBNAME=holiday_system \
		holiday-system:latest

docker-compose-up:
	@echo "ğŸ³ ä½¿ç”¨ docker-compose å•Ÿå‹•..."
	docker-compose up -d
	@echo "âœ… å®¹å™¨å·²å•Ÿå‹•"
	@echo "ğŸ“ API: http://localhost:8080"
	@echo "ğŸ“ æ•¸æ“šåº«: localhost:5432"

docker-compose-down:
	@echo "ğŸ›‘ åœæ­¢ docker-compose..."
	docker-compose down
	@echo "âœ… å®¹å™¨å·²åœæ­¢"

docker-compose-logs:
	@echo "ğŸ“‹ æŸ¥çœ‹æ—¥èªŒ..."
	docker-compose logs -f

gcp-deploy:
	@echo "â˜ï¸  éƒ¨ç½²åˆ° GCP..."
	bash deploy/gcp/deploy.sh
	@echo "âœ… éƒ¨ç½²å®Œæˆ"

gcp-cleanup:
	@echo "ğŸ§¹ æ¸…ç† GCP è³‡æº..."
	bash deploy/gcp/cleanup.sh

lint:
	@echo "ğŸ” é‹è¡Œ linter..."
	golangci-lint run ./...
	@echo "âœ… Lint æª¢æŸ¥å®Œæˆ"

fmt:
	@echo "ğŸ“ æ ¼å¼åŒ–ä»£ç¢¼..."
	go fmt ./...
	@echo "âœ… ä»£ç¢¼æ ¼å¼åŒ–å®Œæˆ"

dev: docker-compose-down docker-compose-up
	@echo "âœ… é–‹ç™¼ç’°å¢ƒå·²å•Ÿå‹•"
	@echo "ğŸ“Š æ•¸æ“šåº«é·ç§»..."
	sleep 2
	docker-compose exec -T api go run ./cmd/migrate/main.go

deps:
	@echo "ğŸ“¦ ä¸‹è¼‰ä¾è³´..."
	go mod download
	go mod tidy
	@echo "âœ… ä¾è³´å·²æ›´æ–°"

version:
	@echo "ç‰ˆæœ¬ä¿¡æ¯"
	@go version
	@echo ""
	@echo "ä¾è³´ï¼š"
	@go list -m all | head -10
